/**
* Schedule AngularJS Module v1.0.0
* https://github.com/albulescu/angular-ca-schedule
*
* Author Albulescu Cosmin <cosmin@albulescu.ro>
* Licensed under the MIT license.
*/

"use strict";angular.module("ca.schedule.templates",[]).run(["$templateCache",function(a){a.put("ca-schedule/directive/schedule.html",'<div class=ca-schedule ng-init=init()><div class=slots><div ng-repeat="slot in slots" class=slot>dsfsdf {{slot.date}}</div></div><!-- <table cellspacing="0" cellpading="0" ng-style="style">\n        <tr class="date-row">\n            <td class="info-cell empty-cell"></td>\n            <td class="info-cell date-cell" ng-repeat="day in days">{{day}}</td>\n        </tr>\n        <tr class="date-row">\n            <td class="info-cell empty-cell"></td>\n            <td class="info-cell date-cell" ng-repeat="date in dates">{{date|date}}</td>\n        </tr>\n        <tr ng-repeat="time in hours track by time.minutes" ng-class="{\'not-sharp\':!time.sharp}">\n            <td class="info-cell time-cell">{{time.nice}}</td>\n            <td schedule-slot="[date, time]"\n                data-time="{{time}}"\n                ng-repeat="date in dates"\n                ng-click="book($event,date,time)"\n                hover-class="schedule-cell-hover"\n                class="schedule-cell" \n                ng-mouseover="cellover($event)"\n                ng-mouseout="cellout($event)"\n                ng-mousedown="onCellDown($event)">\n            </td>\n        </tr>\n    </table> --></div>')}]),angular.module("ca.schedule",["ca.schedule.templates"]).controller("BookingController",["$scope","$injector","$filter","$compile","$document","$timeout","$element","$log","ScheduleTime","MatrixTableFactory","TimeUtils",function(a,b,c,d,e,f,g,h,i,j,k){var l=this;a.date=new Date,a.days=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],a.dates=[],a.hours=[],a.from=0,a.to=23,a.step=30,a.ngModel=null,a.startCell=null,a.interval=!1,a.useAmPm=!0,a.slots=[],a.style={};var m=g.find("table:eq(0)"),n=[],o=!1,p=window.m=j(),q=function(a,b,c){Object.defineProperty(this,"from",{get:function(){return b}}),Object.defineProperty(this,"to",{get:function(){return c}}),Object.defineProperty(this,"date",{get:function(){return a}})},r=function(){if(a.from>a.to)return h.error("From need to be lower than to");for(var b=[],c=60*a.from,d=60*a.to,e=c;d>=e;e+=a.step)b.push(new i(e,a.step));a.hours=b},s=function(b){var c=a.date,d=0===c.getDay()?6:c.getDay()-1;angular.isUndefined(b)&&c.setDate(c.getDate()-d);for(var e=[],f=0;7>f;f++){var g=new Date(c.getTime());g.setDate(c.getDate()+f),e.push(g)}a.dates=e},t=function(b){if(!angular.isUndefined(b)){var c=new Date(b);if(isNaN(c.getTime()))return void h.warn('[BOOKING] date attribute "'+b+'" is invalid. A date string required.');a.date=c,s()}},u=function(b){b&&(b.$render=function(){a.slots=ngModel.$viewValue})},v=function(a){a&&(h.debug("Availability changed to:",a),g.find("table").addClass("has-availability"))},w=function(){if(angular.isArray(a.slots)&&a.slots.length)for(var b=g[0].getBoundingClientRect(),c=g.find(".slots .slot"),d=0;d<a.slots.length;d++){var e=a.slots[d].tds,f=e[0][0].getBoundingClientRect(),h=e[e.length-1][0].getBoundingClientRect();c.eq(d).css({left:f.left-b.left,top:f.top-b.top,width:h.width,height:h.top-f.top+h.height})}};this.setupAvailableSlot=function(d,e,f,g){d.addClass("available");var h=c("date"),i=h(e,"Y-d-m")+" from "+f+" to "+f.to;if(angular.isDefined(g)&&b.has("$tooltip")){var j=a.$new();g.$set("popoverTrigger","mouseenter"),g.$set("popover",i),g.$set("popoverAppendToBody","true"),g.$set("popoverAnimation","false");var k=b.get("$tooltip"),l=k("popover","popover","mouseenter").compile,m=l(d,g);m(j,d,g),d.data("tipScope",j)}else d.attr("title",i)},this.timeAvailable=function(a,b){if(a.length){if(angular.isArray(a[0])){for(var c=0;c<a.length;c++)if(a[c][0]<=b&&a[c][1]>b)return!0}else if(2===a.length&&a[0]<=b&&a[1]>b)return!0;return!1}},a.onCellDown=function(b){return angular.isDefined(a.allowInterval)&&a.allowInterval===!1?void h.warn("Interval selection is disabled"):(a.startCell=angular.element(b.currentTarget),C(a.startCell)?void h.warn("This slot already booked"):D(a.startCell)?(o=!0,a.style.pointer="row-resize",e.bind("mousemove",x),void e.bind("mouseup",y)):(h.warn("This slot is not a valid booking slot"),void(a.startCell=null)))};var x=function(b){var c=angular.element(b.originalEvent.target);if(!a.startCell)throw new Error("Listening on moving event without starting point.");if(!D(c)||!F(b))return void h.warn("Moving on invalid slot cell");a.interval=!0;var d=a.startCell.parent().index(),e=c.parent().index();if(d!==e){console.log(d+"-"+e);for(var f,g,i=!0,j=0;j<n.length;j++)n[j].removeClass("schedule-cell-selecting");if(n=[],m.find("tr").each(function(b,c){if(d>e?(f=e,g=d):(f=d,g=e),b>=f&&g>=b){var h=angular.element(c).find("td").eq(a.startCell.index());if(n.push(h),!h.hasClass("available"))return i=!1,!1}}),!i)return!1;for(var j=0;j<n.length;j++)n[j].addClass("schedule-cell-selecting")}},y=function(b){if(o=!1,a.interval){var c=angular.element(b.originalEvent.target);if(a.startCell[0]!==c[0]){if(e.unbind("mousemove",x),e.unbind("mouseup",y),!F(b)||!E())return void G();if(D(c)){var d=a.dates[a.startCell.index()-1];B(d,JSON.parse(a.startCell.data("time")),J(c)),a.startCell=null,a.interval=!1}}}},z=function(b){if(!o)for(var c=0;c<a.slots[b].tds.length;c++)a.slots[b].tds[c].addClass("slot-hover")},A=function(b){if(!o)for(var c=0;c<a.slots[b].tds.length;c++)a.slots[b].tds[c].removeClass("slot-hover")},B=function(b,c,d){var e=new q(b,c,d);return(a.callback||angular.noop)({$slot:e}),a.ngModel&&a.ngModel.$setViewValue($data.slots),H(e,a.slots.length),a.slots.push(e),a.$digest(),a.slots.length-1},C=function(a){return angular.element(a).hasClass("schedule-cell-selected")},D=function(a){return angular.element(a).hasClass("available")},E=function(){for(var a=0;a<n.length;a++)if(C(n[a]))return!1;return!0},F=function(a){var b=a.originalEvent.target,c=angular.element(b);if("TD"!=b.nodeName||!c.hasClass("schedule-cell"))return!1;var d=c.parents();return-1==d.index(b.parent)?!1:!0},G=function(){for(var a=0;a<n.length;a++)n[a].removeClass("schedule-cell-selecting");n=[]},H=function(a,b){for(var c=0;c<n.length;c++)n[c].removeClass("schedule-cell-selecting").addClass("schedule-cell-selected").data("slot-index",b);a.tds=n,n=[]},I=function(){m.bind("mousewheel",function(b){b.preventDefault(),b.originalEvent.wheelDelta>9?a.date.setDate(a.date.getDate()+1):a.date.setDate(a.date.getDate()-1),f(function(){s(!0)}),a.$digest()})},J=function(b){var c=JSON.parse(b.data("time"));return k.addTime(c,a.step)};a.cellover=function(a){var b=angular.element(a.currentTarget);if("undefined"!=typeof b.data("slot-index")&&z(b.data("slot-index")),b.hasClass("available")){b.addClass("cell-hover"),b.parent().first().addClass("info-cell-highlight");var c=m.find(".date-row");c.eq(0).find("td").eq(b.index()).addClass("info-cell-highlight"),c.eq(1).find("td").eq(b.index()).addClass("info-cell-highlight")}},a.cellout=function(a){var b=angular.element(a.currentTarget);if("undefined"!=typeof b.data("slot-index")&&A(b.data("slot-index")),b.removeClass("cell-hover"),b.hasClass("available")){b.parent().first().removeClass("info-cell-highlight");var c=m.find(".date-row");c.eq(0).find("td").eq(b.index()).removeClass("info-cell-highlight"),c.eq(1).find("td").eq(b.index()).removeClass("info-cell-highlight")}},a.book=function(a,b,c){var d=angular.element(a.originalEvent.target);!C(d)&&D(d)&&(angular.isDefined(d.data("tipScope"))&&d.data("tipScope").$broadcast("$locationChangeSuccess"),d.addClass("schedule-cell-selected"),e.unbind("mousemove",x),e.unbind("mouseup",y),n.push(d),B(b,c,J(d)))},a.init=function(){h.debug("Init booking widget"),a.$watch("step",r),a.$watch("userStep",function(a){a&&(p.scale=a)}),a.$watch("userDate",t),a.$watchCollection("slots",function(){f(w)}),a.$watch("availability",v),a.$watch("ngModel",u),a.allowScrolling&&I(),p.on("matrixValidated",function(){g.html("").append(p.table)});var b=new Date;b.setDate(b.getDate()+1),p.availability=[{date:new Date,slots:[[0,1380]]},{date:b,slots:[[0,1380]]}],s(),r(),(a.bookingReady||angular.noop)({$instance:l,$scope:a})},this.$scope=a,this.$element=g}]),angular.module("ca.schedule").directive("schedule",function(){return{restrict:"E",replace:!0,templateUrl:"ca-schedule/directive/schedule.html",controller:"BookingController",require:["?^ngModel"],scope:{from:"=?",to:"=?",userStep:"@step",userDate:"=date",availability:"=",callback:"&onCreateSlot",allowInterval:"=interval",allowScrolling:"=scrolling",bookingReady:"&ready"},link:function(a,b,c,d){d.length&&(a.ngModel=d[0])}}}),angular.module("ca.schedule").directive("scheduleSlot",["$parse",function(a){return{restrict:"A",require:["^schedule"],link:function(b,c,d,e){var f=e[0],g=f.$scope.availability,h=a(d.scheduleSlot)(b),i=h[0],j=h[1];if(!g||!angular.isArray(g))return f.setupAvailableSlot(c,i,j,d);for(var k=0;k<g.length;k++){var l=g[k];if(l.date.format("Y-d-m")===i.format("Y-d-m")&&f.timeAvailable(l.hours,j.minutes)){f.setupAvailableSlot(c,i,j,d);break}}}}}]),angular.module("ca.schedule").factory("MatrixTableFactory",["DateUtils","TimeUtils",function(a,b){var c=function(a,b,c){b=b.charAt(0).toUpperCase()+b.substr(1);var d=!1,e=null;this.validate=a["validate"+b]=function(){d||(c(),d=!0,a.emit(b.toLowerCase()+"Validated"))},this.invalidate=a["invalidate"+b]=function(){d=!1,clearTimeout(e),e=setTimeout(a["validate"+b].bind(a))}},d=function(){var d=this,e=new Date,f=(new Date,[]),g=60,h=null,i={},j=[],k="dddd<br/>dd-m-yy",l=null,m=!0,n=!1,o=null,p=!1;Object.defineProperty(this,"table",{get:function(){return h}}),Object.defineProperty(this,"scale",{get:function(){return g},set:function(a){if(a%10!==0)throw new Error("Ivalid time scale");g=a,d.invalidateMatrix()}}),Object.defineProperty(this,"weekScroll",{get:function(){return p},set:function(a){p=a}}),Object.defineProperty(this,"availability",{get:function(){return l},set:function(a){l=a,d.invalidateAvailability()}});var q=function(a){return function(b){d.emit("slot."+a,b)}},r=function(a){m&&(n=!0,a.preventDefault(),a.wheelDelta>9?e.setDate(e.getDate()+(p?7:1)):e.setDate(e.getDate()-(p?7:1)),d.invalidateDates(),d.invalidateAvailability(),clearTimeout(o),o=setTimeout(function(){n=!1},1e3))},s=function(){if(!h||!h.dataset.scale||h.dataset.scale!==g){var a=[],c=document.createElement("table");c.dataset.scale=g;for(var e=0;60/g*24+1>e;e++){var i,j,k=document.createElement("tr");if(a[e]=[],0!==e){for(i=0;8>i;i++)if(j=document.createElement("td"),a[e][i]=j,k.appendChild(j),0!==i)j.className="slot",j.addEventListener("mouseover",q("mouseover")),j.addEventListener("mouseout",q("mouseout"));else{j.className="time";var l=(e-1)*g,m=b.zeroFill(Math.floor(l/60)),n=b.zeroFill(l%60);"00"==n&&60>g&&(k.className="nsharp"),a[e][0].innerHTML=m+":"+n}c.appendChild(k)}else{var o=document.createElement("thead"),p=document.createElement("tr");for(a[e].push(o),i=0;8>i;i++)j=document.createElement("th"),a[e][i]=j,p.appendChild(j);o.appendChild(p),c.appendChild(o)}}f=a,h=c,h.addEventListener("mousewheel",r),d.invalidateDates(),d.invalidateAvailability(),console.log("Matrix validated")}},t=function(){var b;angular.element(h).find(".today").removeClass("today");var c=0===e.getDay()?6:e.getDay()-1;for(n||e.setDate(e.getDate()-c),b=0;7>b;b++){var d=new Date(e.getTime());d.setDate(e.getDate()+b),f[0][b+1].innerHTML=a.format(d,k),f[0][b+1].dataset.date=d,a.isToday(d)&&angular.element(f[0][b+1]).addClass("today")}console.log("Dates validated")},u=function(){var b,c,d,e;if(angular.element(h).find(".available").removeClass("available"),f.length)for(b=0;b<l.length;b++)for(c=1;8>c;c++)if(a.equals(new Date(f[0][c].dataset.date),l[b].date)){var i=angular.copy(l[b].slots);for(d=1;d<f.length;d++)for(e=0;e<i.length;e++){var j=(d-1)*g;j>=i[e][0]&&j<i[e][1]&&(angular.element(f[d][c]).addClass("available"),j>=i[e][1]&&i.splice(e,1))}break}},v=function(){};this.validate=function(){j.forEach(function(a){a.validate()})},this.invalidate=function(){j.forEach(function(a){a.invalidate()})},this.on=function(a,b){i[a]=i[a]||[],i[a].push(b)},this.off=function(a,b){a in i!=!1&&i[a].splice(i[a].indexOf(b),1)},this.emit=function(a){if(a in i!=!1)for(var b=0;b<i[a].length;b++)i[a][b].apply(this,Array.prototype.slice.call(arguments,1))},j.push(new c(this,"matrix",s)),j.push(new c(this,"dates",t)),j.push(new c(this,"availability",u)),j.push(new c(this,"slots",v))};return function(){return new d}}]),angular.module("ca.schedule").factory("DateUtils",function(){var a=function(){var b=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,c=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,d=/[^-+\dA-Z]/g,e=function(a,b){for(a=String(a),b=b||2;a.length<b;)a="0"+a;return a};return function(f,g,h){var i=a;if(1!=arguments.length||"[object String]"!=Object.prototype.toString.call(f)||/\d/.test(f)||(g=f,f=void 0),f=f?new Date(f):new Date,isNaN(f))throw SyntaxError("invalid date");g=String(i.masks[g]||g||i.masks["default"]),"UTC:"==g.slice(0,4)&&(g=g.slice(4),h=!0);var j=h?"getUTC":"get",k=f[j+"Date"](),l=f[j+"Day"](),m=f[j+"Month"](),n=f[j+"FullYear"](),o=f[j+"Hours"](),p=f[j+"Minutes"](),q=f[j+"Seconds"](),r=f[j+"Milliseconds"](),s=h?0:f.getTimezoneOffset(),t={d:k,dd:e(k),ddd:i.i18n.dayNames[l],dddd:i.i18n.dayNames[l+7],m:m+1,mm:e(m+1),mmm:i.i18n.monthNames[m],mmmm:i.i18n.monthNames[m+12],yy:String(n).slice(2),yyyy:n,h:o%12||12,hh:e(o%12||12),H:o,HH:e(o),M:p,MM:e(p),s:q,ss:e(q),l:e(r,3),L:e(r>99?Math.round(r/10):r),t:12>o?"a":"p",tt:12>o?"am":"pm",T:12>o?"A":"P",TT:12>o?"AM":"PM",Z:h?"UTC":(String(f).match(c)||[""]).pop().replace(d,""),o:(s>0?"-":"+")+e(100*Math.floor(Math.abs(s)/60)+Math.abs(s)%60,4),S:["th","st","nd","rd"][k%10>3?0:(k%100-k%10!=10)*k%10]};return g.replace(b,function(a){return a in t?t[a]:a.slice(1,a.length-1)})}}();return a.masks={"default":"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"},a.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]},{format:function(b,c,d){return a(b,c,d)},isToday:function(a){return this.equals(a,new Date)},equals:function(a,b){return a.getDate()===b.getDate()&&a.getMonth()===b.getMonth()&&a.getYear()===b.getYear()}}}).factory("TimeUtils",function(){return{zeroFill:function(a){return 10>a?"0"+a:a},addTime:function(a,b){return this.toString(this.toMinutes(a)+b)},toString:function(a){return this.zeroFill(Math.floor(a/60))+":"+this.zeroFill(a%60)},toMinutes:function(a){if(5!=a.length)throw new Error("Invalid time string length");if(!(a||"").match(/^([0-9]+):([0-9]+)$/))throw new Error("Invalid time string");var b=a.split(":");return 60*parseInt(b[0],10)+parseInt(b[1],10)}}}).factory("ScheduleTime",function(){var a=function(b,c){c=c||60;var d=b,e=this,f={},g=function(a){return 10>a?"0"+a:a};this.format=function(a){var b=a;if(f[b])return f[b];a=a||"H:M";var c=Math.floor(d/60),e=d%60;return a=a.replace("h",g(c>12?c-12:c)),a=a.replace("H",g(c)),a=a.replace("m",g(e)),a=a.replace("M",g(e)),a=a.replace("p",c>=12?"pm":"am"),a=a.replace("P",c>=12?"PM":"AM"),f[b]=a,a},this.equal=function(a){return b===a.minutes},this.updateDate=function(a){if(!angular.isDate(a))throw new Error("Date param should be date!");var b=parseInt(this.format("H"),10),c=parseInt(this.format("m"),10);a.setHours(b,c,0)},Object.defineProperty(this,"minutes",{get:function(){return d}}),Object.defineProperty(this,"sharp",{get:function(){return(d-c)%60===0}}),Object.defineProperty(this,"to",{get:function(){return new a(d+c)}}),Object.defineProperty(this,"nice",{get:function(){return e.format("H:m")}}),this.toString=function(){return this.format()},this.toJSON=function(){return this.format()}};return a});