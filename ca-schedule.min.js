/**
* Schedule AngularJS Module v1.0.0
* https://github.com/albulescu/angular-ca-schedule
*
* Author Albulescu Cosmin <cosmin@albulescu.ro>
* Licensed under the MIT license.
*/

"use strict";angular.module("ca.schedule.templates",[]).run(["$templateCache",function(a){a.put("ca-schedule/directive/schedule.html",'<div class=ca-schedule ng-init=init()><table cellspacing=0 cellpading=0><tr class=date-row><td class="info-cell empty-cell"></td><td class="info-cell date-cell" ng-repeat="day in days">{{day}}</td></tr><tr class=date-row><td class="info-cell empty-cell"></td><td class="info-cell date-cell" ng-repeat="date in dates">{{date|date}}</td></tr><tr ng-repeat="time in hours track by time.minutes" ng-class="{\'not-sharp\':!time.sharp}"><td class="info-cell time-cell">{{time.nice}}</td><td schedule-slot="[date, time]" data-time={{time}} ng-repeat="date in dates" ng-click="clearSelection(); book( $event, date, time )" hover-class=schedule-cell-hover class=schedule-cell ng-mouseover=cellover($event) ng-mouseout=cellout($event) ng-mousedown=celldown($event)></td></tr></table></div>')}]),angular.module("ca.schedule",["ca.schedule.templates"]).controller("BookingController",["$scope","$injector","$filter","$compile","$document","$timeout","$element","$log","ScheduleTime",function(a,b,c,d,e,f,g,h,i){var j=this;a.date=new Date,a.days=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],a.dates=[],a.hours=[],a.from=0,a.to=23,a.step=30,a.ngModel=null,a.startCell=null,a.interval=!1,a.useAmPm=!0;var k=function(){if(a.from>a.to)return h.error("From need to be lower than to");for(var b=[],c=60*a.from,d=60*a.to,e=c;d>=e;e+=a.step)b.push(new i(e,a.step));a.hours=b},l=function(b){var c=a.date,d=0===c.getDay()?6:c.getDay()-1;angular.isUndefined(b)&&c.setDate(c.getDate()-d);for(var e=[],f=0;7>f;f++){var g=new Date(c.getTime());g.setDate(c.getDate()+f),e.push(g)}a.dates=e},m=function(b){if(!angular.isUndefined(b)){var c=new Date(b);if(isNaN(c.getTime()))return void h.warn('[BOOKING] date attribute "'+b+'" is invalid. A date string required.');a.date=c,l()}},n=function(b){if(!angular.isUndefined(b)){var c,d=/^(\d+)(h|m)$/,e=0;if(d.test(b)){var f=b.match(d);if(e=f[1],"h"===f[2]&&(e*=60),e>360)return void h.warn("step is to large, use maximum 6h.");if(60%e!==0&&60%e!==60)return void h.warn("step must be divisible with 60. Use 10m, 15m, 30m, 1h");c=parseInt(e,10),isNaN(c)||(a.step=c),h.debug("Step changed to",e,"minutes")}else if(angular.isNumber(b)){if(60%b!==0&&60%b!==60)return void h.warn("step must be divisible with 60. Received:",b);c=parseInt(e,10),isNaN(c)||(a.step=c),h.debug("Step changed to",e,"minutes")}else h.warn("Invalid step expression: Example: 1h, 30m Received:",b)}},o=function(a){a&&(h.debug("Availability changed to:",a),g.find("table").addClass("has-availability"))};this.setupAvailableSlot=function(d,e,f,g){d.addClass("available");var h=c("date"),i=h(e,"Y-d-m")+" from "+f+" to "+f.to;if(angular.isDefined(g)&&b.has("$tooltip")){var j=a.$new();g.$set("popoverTrigger","mouseenter"),g.$set("popover",i),g.$set("popoverAppendToBody","true"),g.$set("popoverAnimation","false");var k=b.get("$tooltip"),l=k("popover","popover","mouseenter").compile,m=l(d,g);m(j,d,g),d.data("tipScope",j)}else d.attr("title",i)},this.timeAvailable=function(a,b){if(a.length){if(angular.isArray(a[0])){for(var c=0;c<a.length;c++)if(a[c][0]<=b&&a[c][1]>b)return!0}else if(2===a.length&&a[0]<=b&&a[1]>b)return!0;return!1}};var p=function(b){var c=angular.element(b.originalEvent.target);if(c.hasClass("schedule-cell")&&a.startCell&&c.hasClass("available")){a.interval=!0;var d=a.startCell.parent().index(),e=c.parent().index(),f=c.parents("table:eq(0)");f.find(".schedule-cell-selected").removeClass("schedule-cell-selected");var g,h,i=[],j=!0;if(f.find("tr").each(function(a,b){if(d>e?(g=e,h=d):(g=d,h=e),a>=g&&h>=a){var f=angular.element(b).find("td").eq(c.index());if(i.push(f),!f.hasClass("available"))return j=!1,!1}}),!j)return!1;for(var k=0;k<i.length;k++)i[k].addClass("schedule-cell-selected")}},q=function(b){if(a.interval){var c=angular.element(b.originalEvent.target);if(a.startCell[0]!==c[0]){if(e.unbind("mousemove",p),e.unbind("mouseup",q),!c.hasClass("available"))return s();var d=a.dates[a.startCell.index()-1];r(d,a.startCell.data("time"),c.data("time")),a.startCell=null,a.interval=!1}}},r=function(b,c,d){var e={date:b,from:c,to:d||null};(a.callback||angular.noop)({$data:e,$event:e})},s=function(){g.find(".schedule-cell-selected").removeClass("schedule-cell-selected")},t=function(){g.find("table").bind("mousewheel",function(b){b.preventDefault(),a.date.setDate(b.originalEvent.wheelDelta>9?a.date.getDate()+1:a.date.getDate()-1),f(function(){l(!0)}),a.$digest()})};this.clear=s,a.cellover=function(a){var b=angular.element(a.currentTarget);if(b.hasClass("available")){b.parent().first().addClass("info-cell-highlight");var c=b.parents("table").find(".date-row");c.eq(0).find("td").eq(b.index()).addClass("info-cell-highlight"),c.eq(1).find("td").eq(b.index()).addClass("info-cell-highlight")}},a.cellout=function(a){var b=angular.element(a.currentTarget);if(b.hasClass("available")){b.parent().first().removeClass("info-cell-highlight");var c=b.parents("table").find(".date-row");c.eq(0).find("td").eq(b.index()).removeClass("info-cell-highlight"),c.eq(1).find("td").eq(b.index()).removeClass("info-cell-highlight")}},a.celldown=function(b){return angular.isDefined(a.allowInterval)&&a.allowInterval===!1?void h.debug("Interval selection is disabled"):(a.startCell=angular.element(b.currentTarget),void(a.startCell.hasClass("available")&&(e.bind("mousemove",p),e.bind("mouseup",q))))},a.book=function(a,b,c){var d=angular.element(a.originalEvent.target);d.hasClass("available")&&(angular.isDefined(d.data("tipScope"))&&d.data("tipScope").$broadcast("$locationChangeSuccess"),s(),d.addClass("schedule-cell-selected"),e.unbind("mousemove",p),e.unbind("mouseup",q),r(b,c,c))},a.init=function(){h.debug("Init booking widget"),a.$watch("step",k),a.$watch("userStep",n),a.$watch("userDate",m),a.$watch("availability",o),a.allowScrolling&&t(),l(),k(),(a.bookingReady||angular.noop)({$instance:j,$scope:a})},this.$scope=a,this.$element=g}]),angular.module("ca.schedule").directive("schedule",function(){return{restrict:"E",templateUrl:"ca-schedule/directive/schedule.html",controller:"BookingController",require:["?^ngModel"],scope:{from:"=?",to:"=?",userStep:"=step",userDate:"=date",availability:"=",callback:"&onBook",allowInterval:"=interval",allowScrolling:"=scrolling",bookingReady:"&ready"},link:function(a,b,c,d){d.length&&(a.ngModel=d[0])}}}),angular.module("ca.schedule").directive("scheduleSlot",["$parse",function(a){return{restrict:"A",require:["^schedule"],link:function(b,c,d,e){var f=e[0],g=f.$scope.availability,h=a(d.scheduleSlot)(b),i=h[0],j=h[1];if(!g||!angular.isArray(g))return f.setupAvailableSlot(c,i,j,d);for(var k=0;k<g.length;k++){var l=g[k];if(l.date.format("Y-d-m")===i.format("Y-d-m")&&f.timeAvailable(l.hours,j.minutes)){f.setupAvailableSlot(c,i,j,d);break}}}}}]),angular.module("ca.schedule").factory("ScheduleTime",function(){var a=function(b,c){c=c||60;var d=b,e=this,f=function(a){return 10>a?"0"+a:a};this.format=function(a){a=a||"H:M";var b=Math.floor(d/60),c=d%60;return a=a.replace("h",f(b>12?b-12:b)),a=a.replace("H",f(b)),a=a.replace("m",f(c)),a=a.replace("M",f(c)),a=a.replace("p",b>=12?"pm":"am"),a=a.replace("P",b>=12?"PM":"AM")},this.equal=function(a){return b===a.minutes},this.updateDate=function(a){if(!angular.isDate(a))throw new Error("Date param should be date!");var b=parseInt(this.format("H"),10),c=parseInt(this.format("m"),10);a.setHours(b,c,0)},Object.defineProperty(this,"minutes",{get:function(){return d}}),Object.defineProperty(this,"sharp",{get:function(){return(d-c)%60===0}}),Object.defineProperty(this,"to",{get:function(){return new a(d+c)}}),Object.defineProperty(this,"nice",{get:function(){return e.format("H:m")}}),this.toString=function(){return this.format()},this.toJSON=function(){return this.format()}};return a});